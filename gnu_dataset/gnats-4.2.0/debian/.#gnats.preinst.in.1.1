#!/bin/sh -e
#
# Gnats installation script -- written by Brian White <bcwhite@pobox.com>
# (This was my very first attempt at learning perl... please forgive me!)
#
# Forgiving -- rewritten to bash :-) by Milan Zamazal <pdm@debian.org>.
# ...and streamlined with SED by Chad Walstrom <chewie@debian.org>

###############################################################################
#
# Utility functions
#

# Call arguments and never return error
protect () { "$@" || true; }

###############################################################################
#
# Common initialization for install scripts
#

. /usr/share/debconf/confmodule

###############################################################################
#
# Fix mistakes from previous versions
#

if [ "$1" = configure ]; then

  for BADDIR in "@GNATSDIR@/gnats-db" "/var/gnats-db"; do

    if [ -d $BADDIR ]; then
      db_subst gnats/baddir_moved GNATSDBDIR @GNATSDBDIR@
      db_subst gnats/baddir_moved BADDIR ${BADDIR}
      protect mkdir -p @GNATSDBPAR@ 2>/dev/null
      chown @GNATSID@:@GNATSGID@ @GNATSDBPAR@
      protect mv $BADDIR @GNATSDBDIR@ 2>/dev/null
      if [ $? -eq 0 ]; then
	db_subst gnats/baddir_moved GNATSDBDIR @GNATSDBDIR@
	db_subst gnats/baddir_moved BADDIR ${BADDIR}
	protect db_input high gnats/baddir_moved
      else
	db_subst gnats/baddir_to_move GNATSDBDIR @GNATSDBDIR@
	db_subst gnats/baddir_to_move BADDIR ${BADDIR}
	protect db_input high gnats/baddir_to_move
      fi
      db_go
    fi

  done

fi

###############################################################################
#
# Automatically added debhelper stuff
#
#DEBHELPER#
