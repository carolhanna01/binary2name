#!/bin/bash
#
# Gnats installation script -- written by Brian White <bcwhite@pobox.com>
# (This was my very first attempt at learning perl... please forgive me!)
#
# Forgiving -- rewritten to bash :-) by Milan Zamazal <pdm@debian.org>.
# ...and streamlined with SED by Chad Walstrom <chewie@debian.org>

set -e

###############################################################################
#
# Utility functions
#

# Call arguments and never return error
function protect () { "$@" || true; }

###############################################################################
#
# Common initialization for install scripts
#

. /usr/share/debconf/confmodule

###############################################################################
#
# Check the 'gnats' userid in the password file
#

if [ "$1" = configure ]; then

  if [ $(protect grep -c "^@GNATSGROUP@:" @GROUPFILE@) -eq 0 ]; then
    adduser --group --gid @GNATSGID@ @GNATSGROUP@
  fi
  
  PWFOUND=$(protect grep -c "^@GNATSUSER@:" @PASSWDFILE@)

  if [ $PWFOUND -gt 1 ]; then
    db_subst gnats/user_multiple PASSWDFILE "@PASSWDFILE@"
    protect db_input high gnats/user_multiple
    protect db_go
  fi

  if [ $PWFOUND -gt 0 ]; then
    if [ $(protect grep -c "^@GNATSUSER@:.*:@GNATSOLDHOME@:" @PASSWDFILE@) -gt 0 ]
    then
      if [ -e @GNATSOLDHOME@/.profile ]; then
	mv @GNATSOLDHOME@/.profile @GNATSHOME@/
      fi
      usermod -d @GNATSHOME@ @GNATSUSER@
    fi
    if [ $(protect grep -c "^@GNATSUSER@:[^:]*:@GNATSID@:@GNATSGID@:" \
           @PASSWDFILE@) \
	 -eq 0 ]
    then
      usermod -u @GNATSID@ -G @GNATSGID@ @GNATSUSER@
    fi
  else
    adduser --quiet --system --home @GNATSHOME@ --no-create-home \
            --gid @GNATSGID@ --shell /bin/sh --disabled-login \
	    --gecos 'GNU GNATS Bug-Reporting System' @GNATSUSER@
  fi

fi


###############################################################################
#
# Automatically added debhelper stuff
#
#DEBHELPER#
