# -*- shell-script -*-
# Cross-compilation instructions

# Copyright (C) 2007, 2008  Sylvain Beucler

# This file is part of GNU FreeDink

# GNU FreeDink is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.

# GNU FreeDink is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see
# <http://www.gnu.org/licenses/>.


# Time: < 30mn
# Space: ~50MB sources + ~150MB build + ~20MB install

# Super-user commands can be disabled using 'SUDO=: ./cross.sh'
# Idem for wget if you already downloaded the tarballs
SUDO=${SUDO=sudo}
WGET=${WGET=wget}

# Default ./configure params
HOST=i586-mingw32msvc
PREFIX=/usr/local/$HOST
# whenever you specify `--host', be sure to specify `--build' too;
# this will be fixed in the future - (autoconf.info)Specifying Names
BUILD=i686-pc-linux-gnu

# Install a cross-compiler version of GCC
$SUDO aptitude install mingw32

# To store cross-compiled libraries
$SUDO mkdir -p -m 775 $PREFIX
# To store source tarballs that will be distributed along with static
# binaries to comply with the GNU GPL and LGPL
if [ ! -e depsources ]; then
  mkdir -m 755 /usr/src/depsources
fi


# Cross-compile yourself
# ----------------------

# This is necessary for static builds (no static libraries are
# provided with the official releases). If feeling lazy and ok with
# .dlls, check "Install precompiled SDL binaries" below.

# SDL
VERSION=1.2.13
cd /usr/src/
# Get non-free DX headers from libsdl.org
$WGET -P depsources/ http://www.libsdl.org/extras/win32/common/directx-devel.tar.gz
tar xzf depsources/directx-devel.tar.gz -C $PREFIX/
$WGET -P depsources/ http://libsdl.org/release/SDL-$VERSION.tar.gz
tar xzf depsources/SDL-$VERSION.tar.gz
cd SDL-$VERSION
CPPFLAGS="-I $PREFIX/include" \
  ./configure --build=$BUILD --host=$HOST \
    --prefix=$PREFIX
# if you don't want stdout.txt and stderr.txt to be created:
#  --disable-stdio-redirect
# note: no need for -L, mingw already has libdsound.a, etc.
# Alternative: get free DX headers from libwine
# Unfortunately SDL fails to compile as of 2008-08-06 :/
# Cross-prefix would be /usr/local/cross-tools/i386-mingw32 by default
#aptitude install libwine-dev
#CPPFLAGS="-I /usr/include/wine/windows"
make
make install
# make install-strip not supported :/
$HOST-strip $PREFIX/bin/SDL.dll


# pkgconfig (used to detect ziplib and zzip in the build system, also
# used by Vorbis to detect Ogg)
VERSION=0.23
cd /usr/src/
$WGET -P depsources/ http://pkgconfig.freedesktop.org/releases/pkg-config-$VERSION.tar.gz
tar xzf depsources/pkg-config-$VERSION.tar.gz
cd pkg-config-$VERSION
./configure --prefix=$PREFIX
make
make install-strip
$SUDO ln -nfs $PREFIX/bin/pkg-config \
  /usr/local/bin/$HOST-pkg-config
# or set
# PKG_CONFIG="$PREFIX/bin/pkg-config"


# libogg (libvorbis dependency)
cd /usr/src/
VERSION=1.1.3
$WGET -P depsources/ http://downloads.xiph.org/releases/ogg/libogg-$VERSION.tar.gz
tar xzf depsources/libogg-$VERSION.tar.gz
cd libogg-$VERSION
./configure --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
make
make install-strip


# libvorbis and libvorbisfile (SDL_mixer dependencies)
cd /usr/src/
VERSION=1.2.0
$WGET -P depsources/ http://downloads.xiph.org/releases/vorbis/libvorbis-$VERSION.tar.gz
tar xzf depsources/libvorbis-$VERSION.tar.gz
cd libvorbis-$VERSION
# Fix cross-compilation
# https://trac.xiph.org/ticket/884
wget -O- 'https://trac.xiph.org/changeset/14833?format=diff&new=14833' | patch -p3
cat <<'EOF' | patch configure.in
--- configure.in~       2007-07-25 16:27:00.000000000 +0000
+++ configure.in        2008-08-09 12:37:44.000000000 +0000
@@ -46,7 +46,8 @@
 AC_PROG_CPP
 CFLAGS="$cflags_save"
 
-AM_PROG_LIBTOOL
+AC_LIBTOOL_WIN32_DLL
+AC_PROG_LIBTOOL
 
 dnl docbook xml transform and processing tools
 AC_ARG_ENABLE(docs,
EOF
autoconf
aclocal
automake
CPPFLAGS="-I$PREFIX/include" \
  LDFLAGS="-L$PREFIX/lib" \
  ./configure --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
make
make install-strip


# SDL_mixer
VERSION=1.2.8
cd /usr/src/
$WGET -P depsources/ http://libsdl.org/projects/SDL_mixer/release/SDL_mixer-$VERSION.tar.gz
tar xzf depsources/SDL_mixer-$VERSION.tar.gz
cd SDL_mixer-$VERSION
# Cross-prefix would be /usr/local/cross-tools/i386-mingw32 by default
# Disable MP3 support (there are patents treats, and there's the Ogg
# Vorbis alternative)
# Adding -L.../bin so it can find .dll. This enables lazy loading
# (e.g. SDL_mixer.dll won't depend on libvorbis-0.dll, but will load
# it at run-time. For normal linking: --disable-music-ogg-shared)
# Let's choose normal linking to avoid inconsistencies and support
# static linking.
CPPFLAGS="-I$PREFIX/include" \
  LDFLAGS="-L$PREFIX/lib -L$PREFIX/bin" \
  SDL_CONFIG=$PREFIX/bin/sdl-config ./configure \
  --build=$BUILD --host=$HOST \
  --prefix=$PREFIX \
  --disable-music-mp3 --enable-music-native-midi-gpl \
  --disable-music-ogg-shared
make
make install
# make install-strip not supported :/
$HOST-strip $PREFIX/bin/SDL_mixer.dll


# FreeType (dependency of SDL_ttf)
VERSION=2.3.7
cd /usr/src/
$WGET -P depsources/ http://download.savannah.gnu.org/releases/freetype/freetype-$VERSION.tar.bz2
tar xjf depsources/freetype-$VERSION.tar.bz2
cd freetype-$VERSION
# Enable bytecode interpreter, that's what distros use most, and we
# need it for compatibility in font metrics. It's disabled by default
# for fear of patent attacks.
# Check:
# - http://freetype.org/patents.html
# - http://bugs.debian.org/447801
# - freetype-2.3.5/docs/TRUETYPE
sed -i -e 's,/\* #define TT_CONFIG_OPTION_BYTECODE_INTERPRETER \*/,#define TT_CONFIG_OPTION_BYTECODE_INTERPRETER,' \
    include/freetype/config/ftoption.h
./configure --build=$BUILD --host=$HOST --prefix=$PREFIX
make
make install
# make install-strip not supported :/
$HOST-strip $PREFIX/bin/libfreetype*.dll


# SDL_ttf
VERSION=2.0.9
cd /usr/src/
$WGET -P depsources/ http://libsdl.org/projects/SDL_ttf/release/SDL_ttf-$VERSION.tar.gz
tar xzf depsources/SDL_ttf-$VERSION.tar.gz
cd SDL_ttf-$VERSION
# Cross-prefix would be /usr/local/cross-tools/i386-mingw32 by default
SDL_CONFIG=$PREFIX/bin/sdl-config \
  FREETYPE_CONFIG=$PREFIX/bin/freetype-config \
  ./configure --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
make
make install-strip


# SDL_gfx
VERSION=2.0.17
cd /usr/src
$WGET -P depsources/ http://www.ferzkopp.net/Software/SDL_gfx-2.0/SDL_gfx-$VERSION.tar.gz
tar xzf depsources/SDL_gfx-$VERSION.tar.gz
cd SDL_gfx-$VERSION
# Build system patches sent to the author, hopefully they will make to
# 2.0.18 :)
patch -p1 < ~/freedink/doc/SDL_gfx-patches/asm_gcc4.3.diff
patch -p1 < ~/freedink/doc/SDL_gfx-patches/libtool_crosscompile.diff
patch -p1 < ~/freedink/doc/SDL_gfx-patches/libtool_static.diff
patch -p1 < ~/freedink/doc/SDL_gfx-patches/asm_win32_nomingw.diff
# Also fix issues with sdl-config, not meant for libraries:
cat <<'EOF' | patch configure.in
--- configure.in~       2008-06-01 11:38:16.000000000 +0000
+++ configure.in        2008-08-09 14:05:54.000000000 +0000
@@ -114,5 +114,7 @@
 )
 CFLAGS="$CFLAGS $SDL_CFLAGS"
+# Remove dependencies from 'sdl-config' not meant for us libraries:
+SDL_LIBS=$(echo "$SDL_LIBS" | sed -e 's/-lmingw32//' -e 's/-lSDLmain//')
 LIBS="$LIBS $SDL_LIBS"
 
 # Finally create all the generated files
EOF
# Rebuild patched build system (make sure you have libtool)
rm acinclude.m4 # rebuild obsolete macros
autoreconf --force --install --symlink
# Cross-prefix would be /usr/local/cross-tools/i386-mingw32msvc by default
SDL_CONFIG=$PREFIX/bin/sdl-config \
  ./configure --build=$BUILD --host=$HOST \
    --prefix=$PREFIX
make
make install-strip

# libjpeg (dependency of SDL_image and libtiff)
cd /usr/src/
$WGET -P depsources/ http://www.ijg.org/files/jpegsrc.v6b.tar.gz
tar xzf depsources/jpegsrc.v6b.tar.gz
cd jpeg-6b
# Generate jconfig.h 
CC=$HOST-gcc RANLIB=$HOST-ranlib \
  ./configure \
  --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
# libjpeg's build system is not suitable for woe cross-compiling, so
# let's use some autotools skills :)
cat <<'EOF' > configure.ac
AC_PREREQ(2.61)
AC_INIT([jpeg],[6b])
AM_INIT_AUTOMAKE([foreign])
AC_CONFIG_HEADERS(config-ignored.h)
AC_PROG_CC
AC_LIBTOOL_WIN32_DLL
AC_PROG_LIBTOOL
AC_CONFIG_FILES([Makefile])
AC_OUTPUT
EOF
# Files from original Makefile, check libjpeg.a/LIBOBJECTS
# Cf. '(libtool.info)Updating version info' for the versioning scheme
cat <<'EOF' > Makefile.am
lib_LTLIBRARIES = libjpeg.la
libjpeg_la_SOURCES = jcomapi.c jutils.c jerror.c jmemmgr.c jmemnobs.c	\
	jcapimin.c jcapistd.c jctrans.c jcparam.c jdatadst.c jcinit.c	\
	jcmaster.c jcmarker.c jcmainct.c jcprepct.c jccoefct.c		\
	jccolor.c jcsample.c jchuff.c jcphuff.c jcdctmgr.c jfdctfst.c	\
	jfdctflt.c jfdctint.c jdapimin.c jdapistd.c jdtrans.c		\
	jdatasrc.c jdmaster.c jdinput.c jdmarker.c jdhuff.c jdphuff.c	\
	jdmainct.c jdcoefct.c jdpostct.c jddctmgr.c jidctfst.c		\
	jidctflt.c jidctint.c jidctred.c jdsample.c jdcolor.c		\
	jquant1.c jquant2.c jdmerge.c
libjpeg_la_LDFLAGS = -no-undefined -version-info 62:0:0
include_HEADERS = jconfig.h jpeglib.h jmorecfg.h jerror.h
EOF
autoreconf -fis
./configure --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
make
make install-strip


# zlib (dependency of libzip and libpng)
VERSION=1.2.3
cd /usr/src
$WGET -P depsources/ http://www.gzip.org/zlib/zlib-$VERSION.tar.gz
tar xzf depsources/zlib-$VERSION.tar.gz
cd zlib-$VERSION
# zlib's build system is not suitable for woe cross-compiling, so
# let's use some autotools skills :)
cat <<EOF > configure.ac
AC_PREREQ(2.61)
AC_INIT([zlib],[$VERSION])
AM_INIT_AUTOMAKE([foreign])
AC_PROG_CC
AC_LIBTOOL_WIN32_DLL
AC_PROG_LIBTOOL
AC_CONFIG_FILES([Makefile])
AC_OUTPUT
EOF
# Cf. '(libtool.info)Updating version info' for the versioning scheme
# Using 'echo' to remove newlines
files=$(echo $(ls *.c *.h | grep -v example.c | grep -v minigzip.c))
cat <<EOF > Makefile.am
lib_LTLIBRARIES = libz.la
libz_la_SOURCES = $files
libz_la_LDFLAGS = -no-undefined -version-info 3:3:2
include_HEADERS = zlib.h zconf.h
EOF
autoreconf -fis
./configure --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
make
make install-strip


# libpng
VERSION=1.2.33
cd /usr/src/
# Download version "with config script"
$WGET -P depsources/ ftp://ftp.simplesystems.org/pub/libpng/png/src/libpng-$VERSION.tar.bz2
tar xjf depsources/libpng-$VERSION.tar.bz2
cd libpng-$VERSION
# Need zlib
CPPFLAGS="-I$PREFIX/include" \
  LDFLAGS="-L$PREFIX/lib" \
  ./configure --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
make
make install-strip


# libtiff
VERSION=3.8.2
cd /usr/src/
# Download version "with config script"
$WGET -P depsources/ ftp://ftp.remotesensing.org/pub/libtiff/tiff-$VERSION.tar.gz
tar xzf depsources/tiff-$VERSION.tar.gz
cd tiff-$VERSION
# Optional zlib and jpeg support OK
# OpenGL support???
CPPFLAGS="-I$PREFIX/include" \
  LDFLAGS="-L$PREFIX/lib" \
  ./configure --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
make
make install-strip


# SDL_image
VERSION=1.2.7
cd /usr/src/
$WGET -P depsources/ http://libsdl.org/projects/SDL_image/release/SDL_image-$VERSION.tar.gz
tar xzf depsources/SDL_image-$VERSION.tar.gz
cd SDL_image-$VERSION
# Cross-prefix would be /usr/local/cross-tools/i386-mingw32 by default.
# See SDL_mixer for explanations about disabled dynamic loading.
SDL_CONFIG=$PREFIX/bin/sdl-config \
  CPPFLAGS="-I $PREFIX/include" \
  LDFLAGS="-L$PREFIX/lib -L$PREFIX/bin" \
  ./configure \
  --build=$BUILD --host=$HOST \
  --prefix=$PREFIX \
  --disable-jpg-shared --disable-png-shared --disable-tif-shared
make
make install-strip

# libzip
VERSION=0.9
cd /usr/src/
$WGET -P depsources/ http://www.nih.at/libzip/libzip-$VERSION.tar.gz
tar xzf depsources/libzip-$VERSION.tar.gz
cd libzip-$VERSION/
CPPFLAGS="-I$PREFIX/include" \
  LDFLAGS="-L$PREFIX/lib" \
  ./configure --build=$BUILD --host=$HOST \
    --prefix=$PREFIX
make
make install-strip


# libffi (DinkC to C bindings)
# Note: the build system only creates static libs for woe, creating
# .dll's would require some libtool tuning, but is pretty useless
# since libffi.a is ~10kB.
cd /usr/src/
VERSION=3.0.7
$WGET -P depsources/ ftp://sourceware.org/pub/libffi/libffi-$VERSION.tar.gz
tar xzf depsources/libffi-$VERSION.tar.gz
cd libffi-$VERSION
./configure --build=$BUILD --host=$HOST \
  --prefix=$PREFIX
make
make install-strip


# Apparently automake's 'install-strip' doesn't necessarily work on
# installed .dll's:
$HOST-strip $PREFIX/bin/*.dll


exit


Cross-compile FreeDink
----------------------

$SUDO aptitude install upx-ucl 
cd ~/freedink/
mkdir cross
cd cross/
SDL_CONFIG=/usr/local/i586-mingw32msvc/bin/sdl-config \
  ../configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --enable-static --enable-upx
make install-strip DESTDIR=`pwd`/destdir
ls -lh destdir/usr/local/bin/*.exe


Install precompiled SDL binaries
--------------------------------

(.dll only)

VERSION=1.2.13
# Cf. http://libsdl.org/download-1.2.php
$WGET http://libsdl.org/release/SDL-devel-$VERSION-mingw32.tar.gz
tar xzf SDL-devel-$VERSION-mingw32.tar.gz
mv SDL-$VERSION/* i386-mingw32msvc/
rmdir SDL-$VERSION

# Install precompiled SDL_mixer binaries
VERSION=1.2.8
$WGET http://libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-$VERSION-VC8.zip
unzip SDL_mixer-devel-$VERSION-VC8.zip
cp -r SDL_mixer-$VERSION/include/* i386-mingw32msvc/include/SDL/
cp -r SDL_mixer-$VERSION/lib/* i386-mingw32msvc/lib/
rm -rf SDL_mixer-$VERSION/

# Install precompiled SDL_ttf binaries
VERSION=2.0.9
$WGET http://libsdl.org/projects/SDL_ttf/release/SDL_ttf-devel-$VERSION-VC8.zip
unzip SDL_ttf-devel-$VERSION-VC8.zip
cp -r SDL_ttf-$VERSION/include/* i386-mingw32msvc/include/SDL/
cp -r SDL_ttf-$VERSION/lib/* i386-mingw32msvc/lib/
rm -rf SDL_ttf-$VERSION/

# (Install precompiled SDL_image binaries)
VERSION=1.2.6
$WGET http://libsdl.org/projects/SDL_image/release/SDL_image-devel-$VERSION-VC8.zip
unzip SDL_image-devel-$VERSION-VC8.zip
cp -r SDL_image-$VERSION/include/* i386-mingw32msvc/include/SDL/
\cp -r SDL_image-$VERSION/lib/* i386-mingw32msvc/lib/
rm -rf SDL_image-$VERSION/

# Cross-compile SDL_gfx (no binaries available)
# (see above)

# Cross-compile libzip (no binaries available)
# (see above)

See also http://www.gtk.org/download-windows.html which has links to
various binaries and dev packages for Windows.


Details on static build
-----------------------

I want to cross-compile statically, to provide a single .exe that
includes SDL and SDL_* :)

- You specify -static

- You add -lwinmm

i586-mingw32msvc-gcc mousetest.c \
  `/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config --cflags \
  --static-libs` -lwinmm

- If you have some troubles with SDL_gfx which tries to use
  __imp__SDL_setFramerate, you need a build system patch (see above) -
  maybe it will make it to 2.0.18 ;)

- You add -lfreetype, a dependency of SDL_ttf

You get a 1.1MB standalone stripped executable.

Now directly available with:
SDL_CONFIG=/usr/local/cross-tools/i386-mingw32msvc/bin/sdl-config \
   ../configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
   --enable-static ...


Misc
----

Those may be used later on.

# zziplib 0.12
$WGET http://dfn.dl.sourceforge.net/sourceforge/zziplib/zziplib-0.12.83.tar.bz2
CPPFLAGS="-I/usr/local/cross-tools/i386-mingw32msvc/include" \
  LDFLAGS="-L/usr/local/cross-tools/i386-mingw32msvc/lib" \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
    --prefix=/usr/local/cross-tools/i386-mingw32msvc
# avoid compiling bins/ which has compilation errors:
cd i586-pc-mingw32msvc/zzip
make
make install-strip
# I think I remember it crashes under woe?

# zziplib 0.13
$WGET http://ovh.dl.sourceforge.net/sourceforge/zziplib/zziplib-0.13.49.tar.bz2
# --disable-mmap because of compilation errors in zzip/mmapped.c
CPPFLAGS="-I/usr/local/cross-tools/i386-mingw32msvc/include" \
  LDFLAGS="-L/usr/local/cross-tools/i386-mingw32msvc/lib" \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
    --prefix=/usr/local/cross-tools/i386-mingw32msvc --disable-mmap
make
# => doesn't work, it tries to use ftello which is apparently missing from mingw

# Guile - dep: libltdl
VERSION=2.2.4
http://ftp.gnu.org/pub/gnu/libtool/libtool-$VERSION.tar.bz2
tar xjf libtool-$VERSION.tar.bz2 
cd libtool-$VERSION
./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install-strip

# Guile - dep: GNU MP
VERSION=4.2.2
$WGET ftp://ftp.gnu.org/gnu/gmp/gmp-$VERSION.tar.bz2
tar xjf gmp-$VERSION.tar.bz2
cd gmp-$VERSION
./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
  --prefix=/usr/local/cross-tools/i386-mingw32msvc
make
make install-strip

# Guile
VERSION=1.8.5
http://ftp.gnu.org/pub/gnu/guile/guile-$VERSION.tar.gz
tar xzf guile-$VERSION.tar.gz
cd guile-$VERSION
CPPFLAGS="-I/usr/local/cross-tools/i386-mingw32msvc/include" \
  LDFLAGS="-L/usr/local/cross-tools/i386-mingw32msvc/lib" \
  ./configure --host=i586-mingw32msvc --build=i686-pc-linux-gnu \
    --prefix=/usr/local/cross-tools/i386-mingw32msvc \
    --disable-shared
make
make install-strip

Some problems need to be fixed:

- Comment obsolete AC_SYS_RESTARTABLE_SYSCALLS in configure.in, plus
  refresh ./configure by running 'autoconf'

- Replace '#ifndef tzname' with '#ifndef HAVE_DECL_TZNAME' in
  libguile/stime.c

- Comment '# define SCM_IMPORT 1' in libguile/guile.c

See:
http://lists.gnu.org/archive/html/bug-guile/2008-05/msg00016.html

# SDL_stretch (alternative to SDL_gfx that has more accurate scaling,
# but this this is being fixed in SDL_gfx)
$WGET http://kent.dl.sourceforge.net/sourceforge/sdl-stretch/SDL_stretch-0.2.3.tar.bz2
tar xjf SDL_stretch-0.2.3.tar.bz2  # 07 Dec 2003...
cd SDL_stretch-0.2.3
...lots errors...


See also
--------

http://gnuwin32.sourceforge.net/ distributes precompiled binaries with
static and shared libraries. The binaries are created using MinGW but
from Windows, so they are not cross-compiled. There is no well-defined
source format, and rebuilding binaries can be difficult because they
can rely on heavily modified gnuwin32-specific build system, and on a
set of helpers (http://gnuwin32.sourceforge.net/compile.html). So
binary packages are probably fine to use as-is. Source instructions
however are not always reusable for cross-compiling by our own means.

http://www.profv.de/mingw_cross_env/ provides a scripted way to
cross-build various libraries (static only though).

http://www.profv.de/debian/ repackages gnuwin32 binaries under the
.deb format for easy installation in a cross-compilation
environment. Again this is fine to use as-is but there is no
recompilation nor instructions for re(cross)compilation.
