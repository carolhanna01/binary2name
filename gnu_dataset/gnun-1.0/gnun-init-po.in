#! @BASH@
# Initialize a translation file.

# Copyright (C) 2012, 2014, 2016, 2018 Free Software Foundation, Inc.

# This file is part of GNUnited Nations.

# GNUnited Nations is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.

# GNUnited Nations is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with GNUnited Nations.  If not, see <https://www.gnu.org/licenses/>.

function version () {
cat <<EOF
gnun-init-po (@PACKAGE_NAME@) @PACKAGE_VERSION@
Copyright (C) 2018 Free Software Foundation, Inc.
You may redistribute copies of @PACKAGE_NAME@
under the terms of the GNU General Public License.
For more information about these matters, see the file named COPYING.
EOF
}

function usage () {
cat <<EOF
Usage: gnun-init-po OPTION... POT

Initialize a PO file.

Options:
  -C, --compendium=COMP      Use compendium
  -d, --disable-diffs        Don't add diffs to previous messages
  -g, --team="NAME <list>"   Specify team
  -l, --language=LANG        Specify language suffix
  -t, --translator="FULL NAME <email>"
                             Specify translator
  -v, --version              Display version info and exit
  -h, --help                 Display this help and exit

Report bugs to @PACKAGE_BUGREPORT@
@PACKAGE_NAME@ home page: <@PACKAGE_URL@>
General help using GNU software: <https://www.gnu.org/gethelp/>
EOF
}

function single_file_needed () {
  echo 1>&2 "$0:" Single FILE argument is required.
  exit 1
}

# Parse command line.

compendia=
language=
translator=
team=
disable_diffs=
FILE=

function parse_option () {
  skip_option=
  trimmed_option=
  end_of_options=
  case "$1" in
      --help | -h* )
	  usage
	  exit 0
	  ;;
      --version | -v* )
	  version
	  exit 0
	  ;;
      --disable-diffs )
          disable_diffs=yes
          ;;
      -d* )
          disable_diffs=yes
          trimmed_option="${1#-d}" 
          ;;
      -t | --translator )
          skip_option=yes
          translator="$2"
          ;;
      --translator=* )
          translator="${1#--translator=}"
          ;;
      -t* )
          translator="${1#-t}"
          ;;
      -g | --team )
          skip_option=yes
          team="$2"
          ;;
      --team=* )
          team="${1#--team=}"
          ;;
      -g* )
          team="${1#-g}"
          ;;
      -l | --language )
	  skip_option=yes
	  language="$2"
	  ;;
      --language=* )
	  language="${1#--language=}"
	  ;;
      -l* )
          language="${1#-l}"
          ;;
      -C | --compendium )
	  skip_option=yes
	  compendia="${compendia} -C $2"
	  ;;
      --compendium=* )
	  compendia="${compendia} -C ${1#--compendium=}"
	  ;;
      -C* )
          compendia="${compendia} -C ${1#-C}"
          ;;
      -- )
          end_of_options=yes
	  ;;
      -* )
          echo 1>&2 "$0:" Invalid option -- \'$1\'.
          exit 1
	  ;;
      * )
          if test "x$FILE" = x; then
            FILE="$1"
          else
            single_file_needed
          fi
	  ;;
  esac
}

while [ $# -ge 1 ]; do
  current_option="$1"
  while test -n "$current_option";do
    parse_option "$current_option" "$2"
    if test -n "$skip_option"; then
      shift
    fi
    if test -n "$trimmed_option"; then
      current_option=-"$trimmed_option"
    else
      current_option=
    fi
  done
  shift
  if test -n "$end_of_options"; then
    break
  fi
done

if test "x$FILE" = x; then
  if test $# -ne 1; then
    single_file_needed
  else
    FILE="$1"
  fi
else
  if test $# -gt 0; then
    single_file_needed
  fi
fi

if test -z "@WDIFF@" && test "$disable_diffs" != yes; then
  disable_diffs=yes
  echo 1>&2 "$0: Note: no wdiff found, fuzzy differences are disabled." 
fi

# Figure out language suffix and PO file name.
article="${FILE%.opt}"
article="${article%.pot}"
article="${article##*/}"

if test -z "${language}" && test -n "${compendia}"; then
  language=${compendia# -C }
  language=${language%% *}
  language=${language%.po}
  language=${language##*.}
fi

if test -z "${language}";then
    echo 1>&2 "$0:" Note: Language suffix is not specified.
fi

po=${article}.${language}.po

revision_date="`date +"%Y-%m-%d %H:%M%z"`"
year=${revision_date%%-*}
creation_date=`@SED@ -n '1,/^$/ \
{s/\\\n"//;/^\(\"POT-Creation-Date: \)/{s/\"POT-Creation-Date: //p;q}}' "$FILE"`

# Figure out language name by its code.
case ${language} in
  af ) PO_LANGUAGE=Afrikaans ;;
  ar ) PO_LANGUAGE=Arabic ;;
  az ) PO_LANGUAGE=Azerbaijani ;;
  bg ) PO_LANGUAGE=Bulgarian ;;
  bn ) PO_LANGUAGE=Bengali ;;
  bs ) PO_LANGUAGE=Bosnian ;;
  ca ) PO_LANGUAGE=Catalan ;;
  cs ) PO_LANGUAGE=Czech ;;
  cy ) PO_LANGUAGE=Welsh ;;
  da ) PO_LANGUAGE=Danish ;;
  de ) PO_LANGUAGE=German ;;
  el ) PO_LANGUAGE=Greek ;;
  en ) PO_LANGUAGE=English ;;
  eo ) PO_LANGUAGE=Esperanto ;;
  es ) PO_LANGUAGE=Spanish ;;
  et ) PO_LANGUAGE=Estonian ;;
  eu ) PO_LANGUAGE=Basque ;;
  fa ) PO_LANGUAGE=Farsi ;;
  fi ) PO_LANGUAGE=Finnish ;;
  fr ) PO_LANGUAGE=French ;;
  ga ) PO_LANGUAGE=Irish ;;
  gl ) PO_LANGUAGE=Galician ;;
  he ) PO_LANGUAGE=Hebrew ;;
  hr ) PO_LANGUAGE=Croatian ;;
  hu ) PO_LANGUAGE=Hungarian ;;
  hy ) PO_LANGUAGE=Armenian ;;
  id ) PO_LANGUAGE=Indonesian ;;
  it ) PO_LANGUAGE=Italian ;;
  ja ) PO_LANGUAGE=Japanese ;;
  ka ) PO_LANGUAGE=Georgian ;;
  kn ) PO_LANGUAGE=Kannada ;;
  ko ) PO_LANGUAGE=Korean ;;
  lt ) PO_LANGUAGE=Lithuanian ;;
  lv ) PO_LANGUAGE=Latvian ;;
  mk ) PO_LANGUAGE=Macedonian ;;
  ml ) PO_LANGUAGE=Malayalam ;;
  mr ) PO_LANGUAGE=Marathi ;;
  ms ) PO_LANGUAGE=Malay ;;
  nb ) PO_LANGUAGE=Norwegian ;;
  nl ) PO_LANGUAGE=Dutch ;;
  nn ) PO_LANGUAGE=Norwegian ;;
  pl ) PO_LANGUAGE=Polish ;;
  pt ) PO_LANGUAGE=Portuguese ;;
  pt-br ) PO_LANGUAGE="Brazilian Portuguese";;
  ro ) PO_LANGUAGE=Romanian ;;
  ru ) PO_LANGUAGE=Russian ;;
  sh ) PO_LANGUAGE=Serbo-Croatian ;;
  sk ) PO_LANGUAGE=Slovak ;;
  sl ) PO_LANGUAGE=Slovenian ;;
  sq ) PO_LANGUAGE=Albanian ;;
  sr ) PO_LANGUAGE=Serbian ;;
  sv ) PO_LANGUAGE=Swedish ;;
  sw ) PO_LANGUAGE=Swahili ;;
  ta ) PO_LANGUAGE=Tamil ;;
  te ) PO_LANGUAGE=Telugu ;;
  th ) PO_LANGUAGE=Thai ;;
  tl ) PO_LANGUAGE=Tagalog ;;
  tr ) PO_LANGUAGE=Turkish ;;
  uk ) PO_LANGUAGE=Ukrainian ;;
  ur ) PO_LANGUAGE=Urdu ;;
  uz ) PO_LANGUAGE=Uzbek ;;
  vi ) PO_LANGUAGE=Vietnamese ;;
  zh-cn ) PO_LANGUAGE="Chinese (Simplified)" ;;
  zh-tw ) PO_LANGUAGE="Chinese (Traditional)" ;;
  zu ) PO_LANGUAGE=Zulu ;;
  * ) PO_LANGUAGE="LANGUAGE" ;;
esac

if test -n "${compendia}"; then
  @MSGMERGE@ --previous ${compendia} -o ${po} /dev/null "$FILE" || exit 1
else
  # No compendium specified: just copy POT.
  cp "$FILE" ${po}
fi

description=$(head -n 1 "$FILE")
# If the first line in the POT file contains "LANGUAGE",
# it is considered to be filled by GNUN; so it should be used
# to fill the URL of the article.
if echo ${description} | grep -q LANGUAGE; then
  @SED@ --in-place \
    "0,/^msgid/{s@.*PACKAGE.*@${description}@;s@LANGUAGE@${PO_LANGUAGE}@}" \
    ${po}
  description=${description/LANGUAGE/${PO_LANGUAGE}}
fi

substitution=
if test -n "${translator}"; then
  escaped="${translator//\//\/}"
  escaped="${escaped//&/\&}"
# Substitute last translator's name and first translator's name (if absent).
  substitution="1,/^$/{s/^\(\"Last-Translator: \).*/\1${escaped}\\\n\"/
    s/# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR./# ${escaped}, ${year}./}"
fi

if test -n "${team}"; then
  escaped="${team//\//\/}"
  escaped="${escaped//&/\&}"
# Substitute team's name and address.
  substitution="${substitution}
1,/^$/s/^\(\"Language-Team: \).*/\1${escaped}\\\n\"/"
fi

# Insert description if it is not present in ${po}.
@SED@ "0,/^msgid/{p;d};q" ${po} | @GREP@ -F "${description}" > /dev/null \
 || @SED@ --in-place "1s|.*|${description}\n&|" ${po}

# Fill some fields.
@SED@ --in-place \
"0,/^msgid/s/\<PACKAGE\>/${article}.html/
 0,/^# [^#]/{/^# [^#]/p;d}
 ${substitution}
# We rely on gettext utilities removing all empty lines in the header.
 1,/^$/{
    s/\<LANGUAGE\>/${PO_LANGUAGE}/
    s/^\(\"Project-Id-Version:\).*/\1 ${article}.html\\\n\"/
    s/^\(\"POT-Creation-Date:\).*/\1 ${creation_date}\\\n\"/
    s/^\(\"PO-Revision-Date:\).*/\1 ${revision_date}\\\n\"/
    s@^\(\"Content-Type: text/plain; charset\)=CHARSET\(\\\n\)\?\"@\1=UTF-8\2\"@
    s/^\(\"Content-Transfer-Encoding:\) ENCODING\(\\\n\)\?\"$/\1 8bit\\\n\"/
    s/^\(\"Language:\).*/\1 ${language}\\\n\"/
  }" ${po}

# Add differences to previous msgids.
if test -z "${disable_diffs}"; then
  @pkglibexecdir@/add-fuzzy-diff -i ${po}
fi
