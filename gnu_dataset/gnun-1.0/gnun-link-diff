#! /bin/bash

# Copyright (C) 2012, 2013, 2014, 2017 Free Software Foundation, Inc.

# This file is part of GNUnited Nations.

# GNUnited Nations is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.

# GNUnited Nations is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with GNUnited Nations.  If not, see <http://www.gnu.org/licenses/>.

# Wrap around link-diff.awk to provide a command line interface compliant
# with GNU Coding Standards.

function version () {
cat <<EOF
gnun-link-diff (GNUnited Nations) 1.0
Copyright (C) 2017 Free Software Foundation, Inc.
You may redistribute copies of GNUnited Nations
under the terms of the GNU General Public License.
For more information about these matters, see the file named COPYING.
EOF
}

function usage () {
cat <<EOF
Usage: gnun-link-diff [OPTION...] [FILE]
Output link and id differences in original vs. translated messages
in a PO file in a HTML format.

Options:
  -t[TITLE], --title[=TITLE]
                 Set page title (default is file name)
  -l[LANG], --language[=LANG]
                 Set language suffix (default is figured out from file name)
  -v, --version  Display version info and exit
  -h, --help     Display this help and exit

Report bugs to bug-gnun@gnu.org
GNUnited Nations home page: <https://www.gnu.org/software/gnun/>
General help using GNU software: <http://www.gnu.org/gethelp/>
EOF
}

function single_file_needed () {
  echo 1>&2 "$0:" Single FILE argument is required.
  exit 2
}

# Parse command line.

language=
title=
file=

function parse_option () {
  skip_option=
  trimmed_option=
  end_of_options=
  case "$1" in
      --help | -h* )
	  usage
	  exit 0
	  ;;
      --version | -v* )
	  version
	  exit 0
	  ;;
      -t | --title )
          skip_option=yes
          title="$2"
          ;;
      --title=* )
          title="${1#--translator=}"
          ;;
      -t* )
          title="${1#-t}"
          ;;
      -l | --language )
	  skip_option=yes
	  language="$2"
	  ;;
      --language=* )
	  language="${1#--language=}"
	  ;;
      -l* )
          language="${1#-l}"
          ;;
      -- )
          end_of_options=yes
	  ;;
      -* )
          echo 1>&2 "$0:" Invalid option -- \'$1\'.
          exit 2
	  ;;
      * )
          if test "x$file" = x; then
            file="$1"
          else
            single_file_needed
          fi
	  ;;
  esac
}

while [ $# -ge 1 ]; do
  current_option="$1"
  while test -n "$current_option";do
    parse_option "$current_option" "$2"
    if test -n "$skip_option"; then
      shift
    fi
    if test -n "$trimmed_option"; then
      current_option=-"$trimmed_option"
    else
      current_option=
    fi
  done
  shift
  if test -n "$end_of_options"; then
    break
  fi
done

if test "x$file" = x; then
  if test $# -ne 1; then
    single_file_needed
  else
    file="$1"
  fi
else
  if test $# -gt 0; then
    single_file_needed
  fi
fi

if test "x$language" = x; then
  language=${file%.po}
  language=${language##*.}
fi

if test "x$title" = x; then
  title=${file##*/}
fi

gawk -f /usr/local/libexec/gnun/link-diff.awk -v language="$language" \
  -v title="$title" "$file"

exit $?
